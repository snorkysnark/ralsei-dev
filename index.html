

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="">
    
    
      
        <title>Ralsei</title>
      
    
    
      
        
        
      
      

    
    
    
      
        
        
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
        <link rel="stylesheet" type="text/css" href="_static/css/columns.css?v=fae03fe1" />
        <link rel="stylesheet" type="text/css" href="_static/css/fix-summary.css?v=7eee24b7" />
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="#" title="Ralsei" class="md-header__button md-logo" aria-label="Ralsei" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>
    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ralsei
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ralsei
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">Overview</span>
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cli" class="md-nav__link">
    <span class="md-ellipsis">Cli</span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-plans" class="md-nav__link">
    <span class="md-ellipsis">Future plans</span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspirations" class="md-nav__link">
    <span class="md-ellipsis">Inspirations</span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset" role="main">
                  


<h1 id="ralsei">Ralsei<a class="headerlink" href="#ralsei" title="Link to this heading">¶</a></h1>
<div class="twocol docutils container">
<div class="leftside docutils container">
<img alt="_images/logo.png" class="logo" src="_images/logo.png" />
</div>
<div class="rightside docutils container">
<p><strong>Ralsei</strong> is an unopinionated data pipeline framework for the database.
It is meant to organize your whole data flow, from downloading to parsing
to transformation, into a reproducible graph of tasks. Develop the pipeline as you go
and resume where you last stopped in case of an error.</p>
</div>
</div>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Although you can create custom tasks, you will mostly be using the 4 basic ones
that either create a table or extend an existing one</p>
<table class="docutils data align-default">
<thead>
<tr class="row-odd"><th class="head"><p>language</p></th>
<th class="head"><p>create table</p></th>
<th class="head"><p>add columns</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>sql</p></td>
<td><p>CreateTableSql</p></td>
<td><p>AddColumnsSql</p></td>
</tr>
<tr class="row-odd"><td><p>python</p></td>
<td><p>MapToNewTable</p></td>
<td><p>MapToNewColumns</p></td>
</tr>
</tbody>
</table>
<p>In this example URLs are loaded from a certain source file,
their contents are downloaded (storing HTML in the database),
a list of organizations gets parsed, then de-duplicated and assigned IDs</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">ralsei</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">MyPipeline</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>

   <span class="k">def</span> <span class="nf">create_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">{</span>
         <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="n">MapToNewTable</span><span class="p">(</span>
            <span class="n">table</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
               <span class="s2">&quot;source_id SERIAL PRIMARY KEY&quot;</span><span class="p">,</span>
               <span class="n">ValueColumn</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">)</span>
            <span class="p">],</span>
             <span class="n">fn</span><span class="o">=</span><span class="n">compose</span><span class="p">(</span><span class="n">_load_sources</span><span class="p">,</span> <span class="n">add_to_input</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">))</span>
         <span class="p">),</span>
         <span class="s2">&quot;download&quot;</span><span class="p">:</span> <span class="n">MapToNewColumns</span><span class="p">(</span>
            <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outputof</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">),</span>
            <span class="n">select</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">            SELECT source_id, url FROM {{table}}</span>
<span class="s2">            WHERE NOT {{is_done}}&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">ValueColumn</span><span class="p">(</span><span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">)],</span>
            <span class="n">is_done_column</span><span class="o">=</span><span class="s2">&quot;__downloaded&quot;</span><span class="p">,</span>
            <span class="n">fn</span><span class="o">=</span><span class="n">compose_one</span><span class="p">(</span><span class="n">_org_download</span><span class="p">,</span> <span class="n">pop_id_fields</span><span class="p">(</span><span class="s2">&quot;source_id&quot;</span><span class="p">))</span>
         <span class="p">),</span>
         <span class="s2">&quot;parse&quot;</span><span class="p">:</span> <span class="n">MapToNewTable</span><span class="p">(</span>
            <span class="n">source_table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outputof</span><span class="p">(</span><span class="s2">&quot;download&quot;</span><span class="p">),</span>
            <span class="n">select</span><span class="o">=</span><span class="s2">&quot;SELECT source_id, html FROM {{source}}&quot;</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="s2">&quot;orgs_raw&quot;</span><span class="p">),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
               <span class="n">ValueColumn</span><span class="p">(</span><span class="s2">&quot;source_id&quot;</span><span class="p">,</span> <span class="s2">&quot;INT REFERENCES {{source}}&quot;</span><span class="p">),</span>
               <span class="n">ValueColumn</span><span class="p">(</span><span class="s2">&quot;org_name&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">fn</span><span class="o">=</span><span class="n">compose</span><span class="p">(</span><span class="n">_org_parse</span><span class="p">,</span> <span class="n">pop_id_fields</span><span class="p">(</span><span class="s2">&quot;source_id&quot;</span><span class="p">))</span>
         <span class="p">),</span>
         <span class="s2">&quot;dedupe&quot;</span><span class="p">:</span> <span class="n">CreateTableSql</span><span class="p">(</span>
            <span class="n">table</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="s2">&quot;orgs&quot;</span><span class="p">),</span>
            <span class="n">sql</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">            CREATE TABLE {{table}}(</span>
<span class="s2">               org_id SERIAL PRIMARY KEY,</span>
<span class="s2">               source_id INT REFERENCES {{sources}},</span>
<span class="s2">               org_name TEXT UNIQUE</span>
<span class="s2">            );</span>
<span class="s2">            {</span><span class="si">%-s</span><span class="s2">plit-%}</span>
<span class="s2">            INSERT INTO {{table}}</span>
<span class="s2">            SELECT DISTINCT ON (org_name)</span>
<span class="s2">            source_id, org_name FROM {{raw}};&quot;&quot;&quot;</span>
         <span class="p">)</span>
      <span class="p">}</span>
</code></pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">_org_parse</span></code> and <code class="docutils literal notranslate"><span class="pre">_load_sources</span></code> are generator functions mapping a single row to multiple rows,
and <code class="docutils literal notranslate"><span class="pre">_org_download</span></code> returns column values added to the same row.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_load_sources</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
    <span class="k">yield</span> <span class="p">{</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="o">...</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">_org_parse</span><span class="p">(</span><span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">yield</span> <span class="p">{</span> <span class="s2">&quot;org_name&quot;</span><span class="p">:</span> <span class="o">...</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">_org_download</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="o">...</span> <span class="p">}</span>
</code></pre></div>
</div>
<p>With all dependencies resolved and templates rendered,
this pipeline is compiled to the following graph:</p>
<a class="reference internal image-reference" href="_images/graph.dot.png"><img alt="_images/graph.dot.png" class="align-center" src="_images/graph.dot.png" style="width: 679.2px; height: 624.8000000000001px;" /></a>
<p>A task will be skipped if its output (table or columns) already exists,
and the <code class="docutils literal notranslate"><span class="pre">download</span></code> task additionally checks the <code class="docutils literal notranslate"><span class="pre">__downloaded</span></code> field to skip processed rows.</p>
<h3 id="cli">Cli<a class="headerlink" href="#cli" title="Link to this heading">¶</a></h3>
<p>Now, let’s create a runnable CLI.
Since our pipeline is initialized with a source file,
we need an additional <a class="reference external" href="https://click.palletsprojects.com/en/8.1.x/">click</a> argument</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><code><span class="n">app</span> <span class="o">=</span> <span class="n">Ralsei</span><span class="p">(</span>
   <span class="n">MyPipeline</span><span class="p">,</span>
   <span class="p">[</span><span class="n">click</span><span class="o">.</span><span class="n">Option</span><span class="p">([</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--sources&quot;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="p">)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="p">()</span>
</code></pre></div>
</div>
<p>To run the entire graph:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><code><span class="go">script.py -s ./sources.csv -d postgresql:///dbname run all</span>
</code></pre></div>
</div>
<p>Additionally, you can delete/redo a certain task and its dependencies
(useful during development)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><code><span class="go">script.py -s ./sources.csv -d postgresql:///dbname delete from parse</span>
</code></pre></div>
</div>
<p>Or even control a specific task (without dependencies)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><code><span class="go">script.py -s ./sources.csv -d postgresql:///dbname run task download</span>
</code></pre></div>
</div>
<p>Currently, <em>postgresql</em> and <em>sqlite</em> are officially supported
(although you’ll need to adjust your SQL
or make your templates universal via <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">%}</span></code> blocks or macros})</p>
<h2 id="future-plans">Future plans<a class="headerlink" href="#future-plans" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Make a proper visualizer/GUI</p></li>
<li><p>More hooks for setting up the database connection and jinja environment</p></li>
</ul>
<h2 id="inspirations">Inspirations<a class="headerlink" href="#inspirations" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/dbt-labs/dbt-core?tab=readme-ov-file">dbt</a> - similarly utilizes jinja templates</p></li>
<li><p><a class="reference external" href="https://github.com/kedro-org/kedro">kedro</a> - pipelines defined programmatically in python, has a visualizer</p></li>
</ul>
<p>These tools, however, are more opinionated:
dbt limits the ways you can structure your database (for example, you have to use surrogate keys)
and kedro has a very rigid project structure.</p>
<p>Both are more suited for the analysis of data you already have (so, no resumable download tasks),
you can even plug the outputs of this library into one of these tools to perform more advanced analysis.</p>




  



                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  
  
  <div class="md-footer-meta md-typeset">
    
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-footer-copyright__highlight">
        &#169; Copyright 2024, snorkysnark.
        
    </div>
  
    Created using
    <a href="https://www.sphinx-doc.org/" target="_blank" rel="noopener">Sphinx</a>
    7.2.6.
     and
    <a href="https://github.com/jbms/sphinx-immaterial/" target="_blank" rel="noopener">Sphinx-Immaterial</a>
  
</div>
      
    </div>
    
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
      
    
  </body>
</html>